<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin Panel – Velorie Market</title>
  <meta name="theme-color" content="#0a1030" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --accent: #ff0354;
      --accent2: #7c3aed;
      --bg1: #00010f;
      --bg2: #0a1030;
      --stroke: rgba(255, 255, 255, .12);
    }

    html { scroll-behavior: smooth; }
    body {
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(255,3,84,.16), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      color: rgba(255,255,255,0.9);
      overflow-x: hidden;
    }

    /* Background animations */
    .grid-bg { position: fixed; inset: 0; pointer-events: none; opacity: .22; z-index: -2; background-image: linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px); background-size: 52px 52px; mask-image: radial-gradient(ellipse at center, rgba(0,0,0,.95) 0%, rgba(0,0,0,.20) 55%, transparent 75%); animation: gridFloat 12s ease-in-out infinite; }
    @keyframes gridFloat { 0%,100% { transform: translate3d(0,0,0) scale(1); } 50% { transform: translate3d(0,-10px,0) scale(1.02); } }
    .aurora { position: fixed; inset: -20%; pointer-events: none; filter: blur(46px) saturate(125%); opacity: .90; z-index: -3; }
    .blob { position: absolute; width: clamp(320px, 40vw, 560px); height: clamp(320px, 40vw, 560px); border-radius: 999px; background: radial-gradient(circle at 30% 30%, rgba(255,3,84,.35), transparent 60%), radial-gradient(circle at 70% 70%, rgba(124,58,237,.35), transparent 60%); animation: blob 14s ease-in-out infinite; mix-blend-mode: screen; }
    .blob.b1 { left: 8%; top: 8%; }
    .blob.b2 { width: clamp(360px, 48vw, 680px); height: clamp(360px, 48vw, 680px); left: 62%; top: 18%; background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.38), transparent 60%), radial-gradient(circle at 70% 70%, rgba(255,3,84,.28), transparent 60%); animation-duration: 18s; animation-delay: -3s; }
    @keyframes blob { 0%,100% { transform: translate(0,0) scale(1); } 30% { transform: translate(40px, 18px) scale(1.08); } 60% { transform: translate(-28px, 34px) scale(0.98); } }
    .noise { position: fixed; inset: 0; pointer-events: none; opacity: .09; z-index: -1; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E"); mix-blend-mode: overlay; }

    /* UI Elements */
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05)); border: 1px solid var(--stroke); box-shadow: 0 18px 60px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.10); backdrop-filter: blur(18px); }
    .glass-soft { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); backdrop-filter: blur(14px); }
    .lift { transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
    .lift:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(0,0,0,.6); }

    .btn-primary { background: linear-gradient(135deg, rgba(255,3,84,1), rgba(124,58,237,1)); box-shadow: 0 12px 26px rgba(255,3,84,.18), 0 10px 32px rgba(124,58,237,.16); transition: all 0.2s; }
    .btn-primary:hover { filter: brightness(1.15); box-shadow: 0 14px 30px rgba(255,3,84,.3); transform: translateY(-1px); }
    .btn-ghost { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); transition: all 0.2s; }
    .btn-ghost:hover { background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.2); }
    .btn-danger { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); color: #f87171; transition: all 0.2s; }
    .btn-danger:hover { background: rgba(239,68,68,.2); box-shadow: 0 0 15px rgba(239,68,68,.2); }

    .v-input { width: 100%; border-radius: 12px; padding: 10px 14px; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.14); color: white; outline: none; transition: all 0.2s; }
    .v-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,3,84,.15); background: rgba(0,0,0,.6); }
    
    .brand-logo { height: 32px; width: auto; max-width: 140px; object-fit: contain; filter: drop-shadow(0 10px 22px rgba(255,3,84,.25)); }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,3,84, 0.6); border-radius: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .glow-card { position: relative; }
    .glow-card::before {
      content: ''; position: absolute; inset: -1px; border-radius: inherit; padding: 1px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    
    .admin-view-hidden { display: none !important; }
    
    /* Mobile Menu Transition */
    .mobile-menu-enter { transform: translateX(0) !important; }
  </style>
</head>
<body class="selection:bg-[#ff0354]/40 selection:text-white flex min-h-screen relative">

  <div class="aurora" aria-hidden="true"><div class="blob b1"></div><div class="blob b2"></div></div>
  <div class="grid-bg" aria-hidden="true"></div>
  <div class="noise" aria-hidden="true"></div>

  <div id="admin-login-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-[var(--bg2)]/95 backdrop-blur-xl transition-opacity duration-300">
    <div class="glass rounded-3xl p-8 max-w-sm w-full mx-4 relative overflow-hidden text-center shadow-2xl">
      <img src="https://i.imgur.com/NDhlWyz.png" alt="Velorie" class="brand-logo mx-auto mb-6 h-10 w-auto" />
      
      <div id="login-step-1">
        <h2 class="text-xl font-bold mb-2">Autoryzacja Admina</h2>
        <p class="text-sm text-white/50 mb-6">Wprowadź hasło główne.</p>
        <input type="password" id="admin-password" class="v-input text-center text-lg mb-4 tracking-widest" placeholder="••••••••" />
        <button onclick="requestAdminOTP()" class="btn-primary w-full py-3 rounded-xl font-bold text-sm">Zaloguj</button>
      </div>

      <div id="login-step-2" class="hidden">
        <i data-lucide="shield-check" class="h-12 w-12 text-[var(--accent)] mx-auto mb-3"></i>
        <h2 class="text-xl font-bold mb-2">Weryfikacja Discord</h2>
        <p class="text-sm text-white/50 mb-6">Wysłaliśmy 6-cyfrowy kod na Twoje konto Discord.</p>
        <input type="text" id="admin-otp" class="v-input text-center text-2xl font-black tracking-[0.5em] mb-4" maxlength="6" placeholder="000000" />
        <button onclick="verifyAdminOTP()" class="btn-primary w-full py-3 rounded-xl font-bold text-sm">Zweryfikuj kod</button>
      </div>
      
      <p id="admin-login-error" class="text-red-400 text-xs font-bold mt-4 h-4"></p>
    </div>
  </div>

  <button id="mobile-toggle" onclick="toggleSidebar()" class="fixed top-4 left-4 z-[60] p-2.5 bg-black/40 backdrop-blur-md border border-white/10 rounded-xl text-white shadow-lg md:hidden hover:bg-white/10 transition">
    <i data-lucide="menu" class="h-6 w-6"></i>
  </button>

  <div id="mobile-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden md:hidden transition-opacity"></div>

  <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 glass-soft border-r border-white/10 flex flex-col transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:h-screen shrink-0 bg-[#00010f]/95 md:bg-transparent">
    <div class="p-5 border-b border-white/10 flex items-center gap-3 mt-12 md:mt-0">
      <img src="https://i.imgur.com/NDhlWyz.png" alt="Velorie" class="brand-logo" />
      <div>
        <div class="text-lg font-bold tracking-tight leading-none">Admin</div>
        <div class="text-[10px] uppercase tracking-widest text-[var(--accent)] font-semibold mt-1">Główny Panel</div>
      </div>
    </div>

    <nav class="flex-1 overflow-y-auto p-4 flex flex-col gap-1.5">
      <div class="text-[10px] uppercase font-bold text-white/40 tracking-wider mb-2 mt-2 px-2">Główne statystyki</div>
      <button onclick="switchAdminTab('dashboard')" id="nav-dashboard" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium bg-[var(--accent)]/10 text-[var(--accent)] glow-card">
        <i data-lucide="layout-dashboard" class="h-4 w-4"></i> Statystyki
      </button>

      <div class="text-[10px] uppercase font-bold text-white/40 tracking-wider mb-2 mt-6 px-2">Zarządzanie</div>
      <button onclick="switchAdminTab('pasek')" id="nav-pasek" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="megaphone" class="h-4 w-4"></i> Pasek informacyjny
      </button>
      <button onclick="switchAdminTab('weryfikacje')" id="nav-weryfikacje" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="check-circle" class="h-4 w-4"></i> Weryfikacje Profili
      </button>
      <button onclick="switchAdminTab('blokada')" id="nav-blokada" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="shield-alert" class="h-4 w-4"></i> Blokada płatności
      </button>

      <div class="text-[10px] uppercase font-bold text-white/40 tracking-wider mb-2 mt-6 px-2">Baza danych</div>
      <button onclick="switchAdminTab('uzytkownicy')" id="nav-uzytkownicy" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="users" class="h-4 w-4"></i> Użytkownicy
      </button>
      <button onclick="switchAdminTab('finanse')" id="nav-finanse" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="banknote" class="h-4 w-4"></i> Finanse
      </button>
      <button onclick="switchAdminTab('kody')" id="nav-kody" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="ticket" class="h-4 w-4"></i> Kody rabatowe
      </button>
      <button onclick="switchAdminTab('ogloszenia')" id="nav-ogloszenia" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="layers" class="h-4 w-4"></i> Ogłoszenia
      </button>
    </nav>

    <div class="p-4 border-t border-white/10 flex items-center justify-between">
      <div class="flex items-center gap-3 px-2">
        <div class="h-10 w-10 rounded-full bg-gradient-to-tr from-[var(--accent)] to-[var(--accent2)] p-0.5">
          <img id="admin-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-full w-full rounded-full bg-[#0a1030] object-cover" />
        </div>
        <div>
          <div id="admin-username" class="text-sm font-bold text-white">SuperAdmin</div>
          <div class="text-[11px] text-white/50">Zarządca systemu</div>
        </div>
      </div>
      <button onclick="logoutAdmin()" class="p-2 text-white/50 hover:text-red-400 transition">
        <i data-lucide="log-out" class="h-5 w-5"></i>
      </button>
    </div>
  </aside>

  <main class="flex-1 p-4 md:p-8 relative z-10 w-full overflow-x-hidden pt-20 md:pt-8">
    
    <div id="view-dashboard" class="space-y-8">
      <div>
        <h1 class="text-3xl sm:text-4xl font-black tracking-tight">Przegląd Systemu</h1>
        <p class="text-white/50 text-sm mt-1">Bieżące statystyki Velorie Market.</p>
      </div>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
        
        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-white/50 uppercase tracking-widest">Użytkownicy (Total)</div>
                <div class="p-2.5 bg-white/5 text-white/80 rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="users" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-users">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-green-400/70 uppercase tracking-widest">Zarobek PLN</div>
                <div class="p-2.5 bg-green-500/10 text-green-400 rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="banknote" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-pln">... <span class="text-sm text-white/40 font-medium">PLN</span></div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-red-400/70 uppercase tracking-widest">Wydane vPLN</div>
                <div class="p-2.5 bg-red-500/10 text-red-400 rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="shopping-cart" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-spent-vpln">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-[#e2b714]/70 uppercase tracking-widest">Posiadane vPLN (Rynek)</div>
                <div class="p-2.5 bg-[#e2b714]/10 text-[#e2b714] rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="wallet" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-owned-vpln">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-blue-400/70 uppercase tracking-widest">Konta Zweryfikowane</div>
                <div class="p-2.5 bg-blue-500/10 text-blue-400 rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="badge-check" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-verified">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-[var(--accent)]/70 uppercase tracking-widest">Aktywne Bannery</div>
                <div class="p-2.5 bg-[var(--accent)]/10 text-[var(--accent)] rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="image" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-banners">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-[var(--accent2)]/70 uppercase tracking-widest">Aktywne Portfolia</div>
                <div class="p-2.5 bg-[var(--accent2)]/10 text-[var(--accent2)] rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="briefcase" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-portfolios">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-white/50 uppercase tracking-widest">Ogłoszenia Zleceń</div>
                <div class="p-2.5 bg-white/5 text-white/80 rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="clipboard-list" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-jobs">...</div>
        </div>

        <div class="glass rounded-3xl p-6 lift relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div class="text-[11px] font-bold text-white/50 uppercase tracking-widest">Profile Freelancerów</div>
                <div class="p-2.5 bg-white/5 text-white/80 rounded-xl group-hover:scale-110 transition-transform"><i data-lucide="contact" class="h-5 w-5"></i></div>
            </div>
            <div class="text-4xl font-black text-white" id="stat-freelancers">...</div>
        </div>

      </div>
    </div>
    
    <div id="view-weryfikacje" class="admin-view-hidden space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-end gap-4">
          <div>
              <h2 class="text-3xl font-black tracking-tight">Weryfikacje Profili</h2>
              <p class="text-sm text-white/50">Zarządzaj statusem "Zweryfikowany" i obsługuj zgłoszenia.</p>
          </div>
          <div class="glass p-4 rounded-2xl flex flex-wrap gap-2 items-center border border-[var(--accent2)]/30">
            <input type="email" id="manual-v-email" placeholder="E-mail użytkownika" class="v-input text-xs w-48" />
            <input type="number" id="manual-v-days" placeholder="Dni" class="v-input text-xs w-20" value="30" />
            <button onclick="adminManualVerify()" class="btn-primary px-4 py-2.5 rounded-xl text-xs font-bold">Dodaj Ręcznie</button>
          </div>
        </div>
      
        <div class="glass rounded-3xl overflow-hidden">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-white/5 text-[10px] uppercase font-bold text-white/40 tracking-widest">
                <th class="px-6 py-4">Użytkownik</th>
                <th class="px-6 py-4">Status</th>
                <th class="px-6 py-4">Wygasa</th>
                <th class="px-6 py-4 text-right">Akcje</th>
              </tr>
            </thead>
            <tbody id="v-table-body" class="divide-y divide-white/5">
              </tbody>
          </table>
        </div>
    </div>

    <div id="view-pasek" class="admin-view-hidden space-y-6 max-w-4xl">
        <h2 class="text-3xl font-black tracking-tight">Pasek Informacyjny</h2>
        
        <div class="flex p-1 bg-white/5 rounded-xl w-fit border border-white/10 mb-2">
            <button onclick="setInfoBarPage('home')" id="bar-tab-home" class="px-6 py-2 rounded-lg text-sm font-bold transition bg-[var(--accent)] text-white shadow-lg">
                Strona Główna
            </button>
            <button onclick="setInfoBarPage('market')" id="bar-tab-market" class="px-6 py-2 rounded-lg text-sm font-bold transition text-white/50 hover:text-white hover:bg-white/5">
                Market
            </button>
        </div>
        <p class="text-white/40 text-xs mb-4">Edytujesz pasek dla: <span id="current-bar-label" class="text-[var(--accent)] font-bold uppercase">Strona Główna</span></p>

        <div class="glass rounded-3xl p-8 border-l-4 border-[var(--accent)] transition-all duration-300" id="bar-editor-container">
          
          <div class="flex items-center justify-between mb-6">
              <span class="text-sm font-bold uppercase tracking-widest text-white/60">Status paska</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="bar-active" class="sr-only peer">
                <div class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                <span class="ml-3 text-sm font-medium text-white">Widoczny na stronie</span>
              </label>
          </div>
  
          <div class="mb-4">
              <label class="block text-xs uppercase font-bold text-white/40 mb-2">Treść komunikatu</label>
              <input type="text" id="bar-text" class="v-input" placeholder="Np. Przerwa techniczna o 22:00..." />
          </div>
  
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                  <label class="block text-xs uppercase font-bold text-white/40 mb-2">Nazwa Linku (opcjonalne)</label>
                  <input type="text" id="bar-link-text" class="v-input" placeholder="Np. Dołącz do Discord" />
              </div>
              <div>
                  <label class="block text-xs uppercase font-bold text-white/40 mb-2">Adres URL (opcjonalne)</label>
                  <input type="text" id="bar-link-url" class="v-input" placeholder="https://..." />
              </div>
          </div>
  
          <div class="grid grid-cols-2 gap-4 mb-8">
              <div>
                  <label class="block text-xs uppercase font-bold text-white/40 mb-2">Kolor tła</label>
                  <div class="flex items-center gap-3">
                      <input type="color" id="bar-bg-color" value="#ff0354" class="h-10 w-10 rounded cursor-pointer bg-transparent border-0" />
                      <span class="text-xs text-white/50">Kliknij, aby wybrać</span>
                  </div>
              </div>
              <div>
                  <label class="block text-xs uppercase font-bold text-white/40 mb-2">Kolor tekstu</label>
                  <div class="flex items-center gap-3">
                      <input type="color" id="bar-text-color" value="#ffffff" class="h-10 w-10 rounded cursor-pointer bg-transparent border-0" />
                  </div>
              </div>
          </div>
  
          <button onclick="saveInfoBar()" class="btn-primary w-full py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
              <i data-lucide="save" class="h-4 w-4"></i> Zapisz zmiany
          </button>
        </div>
      </div>
      
    <div id="view-blokada" class="admin-view-hidden space-y-6 max-w-4xl">
      <h2 class="text-3xl font-black tracking-tight text-red-400">Bezpieczeństwo</h2>
      <div class="glass rounded-3xl p-8 text-center border border-red-500/30">
        <button class="btn-danger px-8 py-4 rounded-xl font-bold">ZABLOKUJ PŁATNOŚCI</button>
      </div>
    </div>

    <div id="view-uzytkownicy" class="admin-view-hidden space-y-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 class="text-3xl font-black tracking-tight">Baza Użytkowników</h2>
          <p class="text-white/50 text-sm mt-1">Wszystkie konta (Formularz + Discord).</p>
        </div>
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/40"></i>
          <input type="text" oninput="filterUsers(this.value)" placeholder="Szukaj (nazwa, email)..." class="v-input pl-10 w-full md:w-64 text-sm" />
        </div>
      </div>

      <div class="glass rounded-3xl overflow-hidden border border-white/5">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse whitespace-nowrap">
            <thead>
              <tr class="bg-white/5 text-[10px] uppercase tracking-widest font-bold text-white/40">
                <th class="px-6 py-4">Użytkownik</th>
                <th class="px-6 py-4">Kontakt / Email</th>
                <th class="px-6 py-4">Rejestracja</th>
                <th class="px-6 py-4 text-center">Saldo</th>
                <th class="px-6 py-4 text-right">Opcje</th>
              </tr>
            </thead>
            <tbody id="users-table-body" class="divide-y divide-white/5">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-finanse" class="admin-view-hidden space-y-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 class="text-3xl font-black tracking-tight">Finanse i Transakcje</h2>
          <p class="text-white/50 text-sm mt-1">Historia wszystkich operacji w systemie (Sklep, Admin, Doładowania).</p>
        </div>
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/40"></i>
          <input type="text" oninput="filterTransactions(this.value)" placeholder="Szukaj (użytkownik, opis)..." class="v-input pl-10 w-full md:w-64 text-sm" />
        </div>
      </div>

      <div class="glass rounded-3xl overflow-hidden border border-white/5">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse whitespace-nowrap">
            <thead>
              <tr class="bg-white/5 text-[10px] uppercase tracking-widest font-bold text-white/40">
                <th class="px-6 py-4">Data</th>
                <th class="px-6 py-4">Użytkownik</th>
                <th class="px-6 py-4">Typ Operacji</th>
                <th class="px-6 py-4">Opis</th>
                <th class="px-6 py-4 text-right">Kwota</th>
              </tr>
            </thead>
            <tbody id="transactions-table-body" class="divide-y divide-white/5">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-kody" class="admin-view-hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h2 class="text-3xl font-black tracking-tight">Kody Rabatowe</h2>
            <p class="text-sm text-white/50">Zarządzaj zniżkami i śledź ile użytkownicy zaoszczędzili.</p>
        </div>
      </div>
      
      <div class="glass p-6 rounded-3xl border border-[var(--accent2)]/30">
        <h3 class="text-sm font-bold uppercase text-white/60 mb-4 tracking-widest">Utwórz nowy kod</h3>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <input type="text" id="code-name" placeholder="np. START20" class="v-input text-sm uppercase font-bold" />
          <input type="number" id="code-percent" placeholder="Zniżka % (np. 20)" class="v-input text-sm" />
          <input type="number" id="code-uses" placeholder="Max użyć (puste = ∞)" class="v-input text-sm" />
          <input type="text" id="code-duration" placeholder="Czas (np. 30min, 1d, 1mc)" class="v-input text-sm" />
          <button onclick="createDiscountCode()" class="btn-primary rounded-xl text-sm font-bold flex items-center justify-center gap-2">
            <i data-lucide="plus" class="h-4 w-4"></i> Utwórz
          </button>
        </div>
        <p class="text-xs text-white/40 mt-3">Formaty czasu: <b>min</b> (minuty), <b>h</b> (godziny), <b>d</b> (dni), <b>t</b> (tygodnie), <b>mc</b> (miesiące).</p>
      </div>
      
      <div class="glass rounded-3xl overflow-hidden border border-white/5">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse whitespace-nowrap">
            <thead>
              <tr class="bg-white/5 text-[10px] uppercase tracking-widest font-bold text-white/40">
                <th class="px-6 py-4">Kod</th>
                <th class="px-6 py-4">Zniżka</th>
                <th class="px-6 py-4">Wykorzystano</th>
                <th class="px-6 py-4">Wygasa</th>
                <th class="px-6 py-4 text-green-400">Zaoszczędzono</th>
                <th class="px-6 py-4 text-right">Akcje</th>
              </tr>
            </thead>
            <tbody id="codes-table-body" class="divide-y divide-white/5">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-ogloszenia" class="admin-view-hidden">
        <h2 class="text-3xl font-black tracking-tight mb-6">Ogłoszenia</h2>
    </div>

  </main>

  <div id="user-modal" class="fixed inset-0 z-[110] hidden items-end md:items-center justify-center p-0 md:p-4 bg-black/80 backdrop-blur-md">
    <div class="glass w-full rounded-t-3xl md:rounded-3xl overflow-hidden relative shadow-2xl h-[85vh] md:h-auto md:max-h-[90vh] max-w-4xl flex flex-col md:flex-row">
      <button onclick="closeUserModal()" class="absolute top-4 right-4 z-50 p-2 bg-black/50 rounded-full text-white/40 hover:text-white transition"><i data-lucide="x"></i></button>
      
      <div class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-white/10 p-6 flex flex-col gap-6 bg-black/20 overflow-y-auto shrink-0">
         <div class="flex flex-col items-center text-center">
            <img id="modal-user-avatar" src="" class="h-20 w-20 md:h-28 md:w-28 rounded-full border-4 border-[var(--bg2)] shadow-xl object-cover mb-4" />
            <h3 id="modal-user-name" class="text-xl md:text-2xl font-black leading-tight break-all">---</h3>
            <p id="modal-user-email" class="text-white/40 text-xs mt-1 break-all">---</p>
            <div id="modal-discord-label" class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-[#5865F2]/20 text-[#5865F2] text-[10px] font-bold rounded uppercase hidden">
               <i data-lucide="gamepad-2" class="h-3 w-3"></i> Discord
            </div>
            <div id="modal-form-label" class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-white/10 text-white/60 text-[10px] font-bold rounded uppercase hidden">
                <i data-lucide="mail" class="h-3 w-3"></i> Formularz
            </div>
            <div class="text-[10px] text-white/30 mt-3" id="modal-user-date">Dołączył: ---</div>
         </div>

         <div class="glass-soft p-5 rounded-2xl">
            <label class="text-[10px] uppercase font-bold text-white/40 block mb-2">Saldo Portfela</label>
            <div class="text-3xl font-black text-[#e2b714] mb-4 text-center"><span id="modal-user-balance">0.00</span> vPLN</div>
            <div class="flex flex-col gap-2">
               <input type="number" id="vpln-amount" class="v-input text-center text-sm" placeholder="Kwota" />
               <div class="flex gap-2">
                 <button onclick="changeBalance('add')" class="flex-1 bg-green-500/10 hover:bg-green-500/20 text-green-400 py-2 rounded-lg text-xs font-bold border border-green-500/20 transition">DODAJ</button>
                 <button onclick="changeBalance('sub')" class="flex-1 bg-red-500/10 hover:bg-red-500/20 text-red-400 py-2 rounded-lg text-xs font-bold border border-red-500/20 transition">ODEJMIJ</button>
               </div>
            </div>
         </div>

         <div class="mt-auto">
            <button onclick="openDeleteConfirm()" class="w-full btn-danger py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="h-4 w-4"></i> Usuń konto trwale
            </button>
         </div>
      </div>

      <div class="w-full md:w-2/3 p-6 flex flex-col gap-6 overflow-y-auto bg-[var(--bg2)]/50">
        
        <div>
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="layers" class="h-5 w-5 text-[var(--accent)]"></i>
                <h4 class="text-sm font-bold uppercase tracking-widest text-white/80">Ogłoszenia / Profile</h4>
            </div>
            <div id="modal-user-ads" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                <div class="text-white/30 text-xs italic">Brak aktywnych ogłoszeń.</div>
            </div>
        </div>

        <div class="w-full h-px bg-white/10"></div>

        <div class="flex-1">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="history" class="h-5 w-5 text-blue-400"></i>
                <h4 class="text-sm font-bold uppercase tracking-widest text-white/80">Ostatnie Transakcje</h4>
            </div>
            <div class="glass-soft rounded-xl overflow-hidden border border-white/5">
                <table class="w-full text-left text-xs">
                    <thead class="bg-white/5 text-white/40 font-semibold">
                        <tr>
                            <th class="p-3">Data</th>
                            <th class="p-3">Typ</th>
                            <th class="p-3 text-right">Kwota</th>
                        </tr>
                    </thead>
                    <tbody id="modal-user-transactions" class="divide-y divide-white/5">
                        <tr><td colspan="3" class="p-4 text-center text-white/30 italic">Brak historii transakcji.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>
  </div>

  <div id="delete-confirm-modal" class="fixed inset-0 z-[120] hidden items-center justify-center bg-black/95 backdrop-blur-sm p-4">
    <div class="glass max-w-sm w-full p-8 rounded-3xl text-center">
      <i data-lucide="alert-triangle" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
      <h4 class="text-2xl font-black mb-2">Jesteś pewny?</h4>
      <p class="text-white/50 text-sm mb-8">Usunięcie konta z MongoDB jest nieodwracalne. Znikną również wszystkie ogłoszenia i saldo.</p>
      <div class="flex gap-4">
        <button onclick="closeDeleteConfirm()" class="flex-1 btn-ghost py-3 rounded-xl">Anuluj</button>
        <button onclick="deleteUser()" class="flex-1 btn-danger py-3 rounded-xl">Usuń</button>
      </div>
    </div>
  </div>

  <div id="toast-notification" class="fixed top-6 right-6 z-[150] translate-x-full opacity-0 transition-all duration-500 flex items-center gap-3 px-6 py-4 rounded-2xl bg-green-500/20 border border-green-500/50 backdrop-blur-md shadow-2xl pointer-events-none">
    <div id="toast-icon-container" class="h-6 w-6 flex items-center justify-center">
        <svg id="toast-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
    </div>
    <div>
        <h4 id="toast-title" class="font-bold text-green-400 text-sm">Sukces</h4>
        <p id="toast-message" class="text-xs text-green-200">Operacja zakończona pomyślnie.</p>
    </div>
  </div>

  <script>
    lucide.createIcons();

    let allUsers = [];
    let selectedUserId = null;

    // --- TOAST NOTIFICATION SYSTEM ---
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast-notification');
        const msg = document.getElementById('toast-message');
        const title = document.getElementById('toast-title');
        const icon = document.getElementById('toast-icon');

        msg.innerText = message;

        if (isError) {
            toast.classList.replace('bg-green-500/20', 'bg-red-500/20');
            toast.classList.replace('border-green-500/50', 'border-red-500/50');
            title.classList.replace('text-green-400', 'text-red-400');
            title.innerText = "Błąd";
            icon.innerHTML = '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>'; 
            icon.classList.replace('text-green-400', 'text-red-400');
        } else {
            toast.classList.replace('bg-red-500/20', 'bg-green-500/20');
            toast.classList.replace('border-red-500/50', 'border-green-500/50');
            title.classList.replace('text-red-400', 'text-green-400');
            title.innerText = "Sukces";
            icon.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/>';
            icon.classList.replace('text-red-400', 'text-green-400');
        }

        // Show
        toast.classList.remove('translate-x-full', 'opacity-0');

        // Hide after 3s
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
        }, 3000);
    }

    // --- MOBILE MENU LOGIC ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const backdrop = document.getElementById('mobile-backdrop');
      
      if (sidebar.classList.contains('mobile-menu-enter')) {
        sidebar.classList.remove('mobile-menu-enter');
        backdrop.classList.add('hidden');
      } else {
        sidebar.classList.add('mobile-menu-enter');
        backdrop.classList.remove('hidden');
      }
    }

    // 1. POBIERANIE Z MONGODB (API)
    async function fetchUsersFromDB() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch('/api/admin/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Błąd pobierania danych");
        allUsers = await res.json();
        renderUsersTable(allUsers);
      } catch (err) {
        console.error("MongoDB Fetch Error:", err);
      }
    }

    // --- POBIERANIE STATYSTYK DASHBOARDU ---
    async function fetchDashboardStats() {
        const token = localStorage.getItem('adminToken');
        if (!token) return;

        try {
            const res = await fetch('/api/admin/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Błąd pobierania statystyk");
            
            const stats = await res.json();
            
            document.getElementById('stat-users').innerText = stats.totalUsers || 0;
            document.getElementById('stat-pln').innerHTML = `${Number(stats.plnEarned || 0).toFixed(2)} <span class="text-sm text-white/40 font-medium">PLN</span>`;
            document.getElementById('stat-spent-vpln').innerText = Number(stats.vplnSpent || 0).toFixed(2);
            document.getElementById('stat-owned-vpln').innerText = Number(stats.vplnOwned || 0).toFixed(2);
            document.getElementById('stat-verified').innerText = stats.verifiedUsers || 0;
            document.getElementById('stat-banners').innerText = stats.activeBanners || 0;
            document.getElementById('stat-portfolios').innerText = stats.activePortfolios || 0;
            document.getElementById('stat-jobs').innerText = stats.jobAds || 0;
            document.getElementById('stat-freelancers').innerText = stats.freelancerProfiles || 0;
            
        } catch (err) {
            console.error("Dashboard Stats Error:", err);
            showToast("Błąd ładowania statystyk", true);
        }
    }

    // 2. RENDEROWANIE TABELI - WSZYSCY UŻYTKOWNICY
    function renderUsersTable(users) {
      const tbody = document.getElementById('users-table-body');
      
      if(users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-white/30">Brak użytkowników w bazie.</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        const dateObj = new Date(user.createdAt);
        const dateStr = dateObj.toLocaleDateString('pl-PL');
        const timeStr = dateObj.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

        return `
        <tr class="hover:bg-white/[0.02] transition group cursor-pointer" onclick="openUserModal('${user._id}')">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <img src="${user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user.username || user.email)}" class="h-10 w-10 rounded-xl object-cover bg-white/5" />
              <div>
                <div class="font-bold text-sm text-white flex items-center gap-1">
                    ${user.username || user.name || 'Brak nazwy'}
                    ${user.isVerified ? '<i data-lucide="badge-check" class="h-4 w-4 text-green-400"></i>' : ''}
                </div>
                ${user.discordId 
                    ? '<div class="inline-flex items-center gap-1 text-[9px] font-black text-[#5865F2] uppercase bg-[#5865F2]/10 px-1.5 py-0.5 rounded mt-1"><i data-lucide="gamepad-2" class="h-2 w-2"></i> Discord</div>' 
                    : '<div class="inline-flex items-center gap-1 text-[9px] font-bold text-white/40 uppercase bg-white/5 px-1.5 py-0.5 rounded mt-1"><i data-lucide="mail" class="h-2 w-2"></i> Formularz</div>'}
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-white/70">${user.email}</td>
          <td class="px-6 py-4">
             <div class="text-sm font-medium text-white/80">${dateStr}</div>
             <div class="text-xs text-white/30">${timeStr}</div>
          </td>
          <td class="px-6 py-4 text-center font-bold text-[#e2b714] tracking-wide">${Number(user.vpln || 0).toFixed(2)} vPLN</td>
          <td class="px-6 py-4 text-right">
            <button class="btn-ghost p-2.5 rounded-xl opacity-0 group-hover:opacity-100 transition hover:bg-white/10 text-white">
              <i data-lucide="settings-2" class="h-4 w-4"></i>
            </button>
          </td>
        </tr>
      `}).join('');
      lucide.createIcons();
    }

    // 3. FILTROWANIE
    function filterUsers(query) {
      const filtered = allUsers.filter(u => 
        (u.username && u.username.toLowerCase().includes(query.toLowerCase())) || 
        (u.name && u.name.toLowerCase().includes(query.toLowerCase())) ||
        (u.email && u.email.toLowerCase().includes(query.toLowerCase()))
      );
      renderUsersTable(filtered);
    }

    // 4. ZARZĄDZANIE SALDEM (API)
    async function changeBalance(type) {
      const amount = parseFloat(document.getElementById('vpln-amount').value);
      if (!amount) return;

      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(`/api/admin/users/${selectedUserId}/balance`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ amount: type === 'add' ? amount : -amount })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          await fetchUsersFromDB(); 
          const updatedUser = allUsers.find(u => u._id === selectedUserId);
          if(updatedUser) {
             document.getElementById('modal-user-balance').innerText = Number(updatedUser.vpln || 0).toFixed(2);
             addMockTransaction(type === 'add' ? amount : -amount, "Korekta Admina");
          }
          document.getElementById('vpln-amount').value = '';
          showToast(type === 'add' ? "Dodano środki!" : "Odjęto środki!");
        } else {
          showToast(data.error || "Błąd podczas zapisu na serwerze", true);
        }
      } catch (err) { 
          showToast("Krytyczny błąd połączenia z API", true); 
      }
    }

    // 5. USUWANIE (API)
    async function deleteUser() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(`/api/admin/users/${selectedUserId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          closeDeleteConfirm();
          closeUserModal();
          showToast("Użytkownik usunięty pomyślnie.");
          await fetchUsersFromDB();
        }
      } catch (err) { showToast("Błąd usuwania użytkownika", true); }
    }

    // --- MODALE UŻYTKOWNIKA ---
    function openUserModal(id) {
      selectedUserId = id;
      const user = allUsers.find(u => u._id === id);
      if (!user) return;

      document.getElementById('modal-user-name').innerText = user.username || user.name || 'Użytkownik';
      document.getElementById('modal-user-email').innerText = user.email;
      document.getElementById('modal-user-balance').innerText = Number(user.vpln || 0).toFixed(2);
      document.getElementById('modal-user-avatar').src = user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user.username || user.email);
      
      const regDate = new Date(user.createdAt);
      document.getElementById('modal-user-date').innerText = "Dołączył: " + regDate.toLocaleString('pl-PL');

      const discLabel = document.getElementById('modal-discord-label');
      const formLabel = document.getElementById('modal-form-label');
      
      if (user.discordId) {
          discLabel.classList.remove('hidden');
          formLabel.classList.add('hidden');
      } else {
          discLabel.classList.add('hidden');
          formLabel.classList.remove('hidden');
      }

      renderUserAds(user.listings || []); 
      renderUserTransactions(user.transactions || []); 

      document.getElementById('user-modal').classList.remove('hidden');
      document.getElementById('user-modal').classList.add('flex');
    }

    function renderUserAds(ads) {
        const container = document.getElementById('modal-user-ads');
        if (!ads || ads.length === 0) {
            container.innerHTML = '<div class="p-4 rounded-xl bg-white/5 border border-white/5 text-center text-white/30 text-xs">Brak aktywnych ogłoszeń lub profili.</div>';
            return;
        }
        container.innerHTML = ads.map(ad => `
            <div class="p-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between group hover:bg-white/10 transition">
                <div>
                    <div class="font-bold text-sm text-white">${ad.title || 'Ogłoszenie bez tytułu'}</div>
                    <div class="text-[10px] text-white/50">${ad.category || 'Ogólne'}</div>
                </div>
                <div class="text-[#e2b714] font-bold text-xs">${Number(ad.price || 0).toFixed(2)} vPLN</div>
            </div>
        `).join('');
    }

    function renderUserTransactions(transactions) {
        const container = document.getElementById('modal-user-transactions');
        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-white/30 text-xs">Brak historii transakcji.</td></tr>';
            return;
        }
        container.innerHTML = transactions.map(t => `
            <tr class="hover:bg-white/5">
                <td class="p-3 text-white/60">${new Date(t.date).toLocaleDateString()}</td>
                <td class="p-3 text-white">${t.type}</td>
                <td class="p-3 text-right font-bold ${t.amount > 0 ? 'text-green-400' : 'text-red-400'}">
                    ${t.amount > 0 ? '+' : ''}${Number(t.amount || 0).toFixed(2)} vPLN
                </td>
            </tr>
        `).join('');
    }

    function addMockTransaction(amount, type) {
        const container = document.getElementById('modal-user-transactions');
        const emptyMsg = container.querySelector('td[colspan="3"]');
        if(emptyMsg) container.innerHTML = '';
        
        const row = document.createElement('tr');
        row.className = "hover:bg-white/5 animate-pulse";
        row.innerHTML = `
            <td class="p-3 text-white/60">Teraz</td>
            <td class="p-3 text-white">${type}</td>
            <td class="p-3 text-right font-bold ${amount > 0 ? 'text-green-400' : 'text-red-400'}">
                ${amount > 0 ? '+' : ''}${Number(amount || 0).toFixed(2)} vPLN
            </td>
        `;
        container.insertBefore(row, container.firstChild);
    }

    function closeUserModal() { document.getElementById('user-modal').classList.add('hidden'); document.getElementById('user-modal').classList.remove('flex'); }
    function openDeleteConfirm() { document.getElementById('delete-confirm-modal').classList.remove('hidden'); document.getElementById('delete-confirm-modal').classList.add('flex'); }
    function closeDeleteConfirm() { document.getElementById('delete-confirm-modal').classList.add('hidden'); }

    // --- ZAKŁADKA: WERYFIKACJE PROFILI ---
    async function fetchVerifications() {
        const token = localStorage.getItem('adminToken');
        try {
            const res = await fetch('/api/admin/verifications', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(!res.ok) throw new Error("Błąd pobierania");
            const users = await res.json();
            const tbody = document.getElementById('v-table-body');
            
            tbody.innerHTML = users.length ? users.map(user => `
                <tr class="hover:bg-white/[0.02] transition">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <img src="${user.avatar}" class="h-9 w-9 rounded-full bg-black/20" />
                            <div>
                                <div class="text-sm font-bold text-white">${user.username}</div>
                                <div class="text-[10px] text-white/40">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-[10px] font-black uppercase ${user.verificationStatus === 'pending' ? 'bg-amber-500/20 text-amber-500' : 'bg-green-500/20 text-green-500'}">
                            ${user.verificationStatus === 'pending' ? 'OCZEKUJE' : 'AKTYWNY'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-xs text-white/60">
                        ${user.verifiedUntil ? new Date(user.verifiedUntil).toLocaleDateString() : 'Brak danych'}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2">
                            ${user.verificationStatus === 'pending' ? 
                                `<button onclick="verifyAction('${user._id}', 'approve')" class="p-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-400 hover:text-black transition" title="Akceptuj"><i data-lucide="check" class="h-4 w-4"></i></button>` : ''
                            }
                            <button onclick="verifyAction('${user._id}', 'revoke')" class="p-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition" title="Usuń weryfikację"><i data-lucide="shield-off" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="p-10 text-center text-white/20">Brak aktywnych zgłoszeń.</td></tr>';
            lucide.createIcons();
        } catch (err) {
            console.error(err);
        }
    }

    async function verifyAction(id, action) {
        const token = localStorage.getItem('adminToken');
        try {
            const res = await fetch(`/api/admin/verifications/${action}/${id}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                showToast(action === 'approve' ? "Weryfikacja przyznana!" : "Weryfikacja odebrana!");
                fetchVerifications();
            } else {
                showToast("Błąd podczas akcji.", true);
            }
        } catch(err) {
            showToast("Błąd sieci.", true);
        }
    }

    async function adminManualVerify() {
        const email = document.getElementById('manual-v-email').value;
        const days = document.getElementById('manual-v-days').value;
        const token = localStorage.getItem('adminToken');
        
        if(!email || !days) return showToast("Wypełnij wszystkie pola", true);

        try {
            const res = await fetch('/api/admin/verifications/manual', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, days })
            });
            
            if(res.ok) {
                showToast("Weryfikacja dodana ręcznie!");
                document.getElementById('manual-v-email').value = '';
                fetchVerifications();
            } else {
                showToast("Nie znaleziono użytkownika.", true);
            }
        } catch (err) {
            showToast("Błąd sieci.", true);
        }
    }

    // --- SYSTEMOWE ---
    function switchAdminTab(tabName) {
      document.querySelectorAll('button[id^="nav-"]').forEach(btn => {
        btn.className = "w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5";
      });
      const activeBtn = document.getElementById(`nav-${tabName}`);
      activeBtn.className = "w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium bg-[var(--accent)]/10 text-[var(--accent)] glow-card";

      const views = ['dashboard', 'pasek', 'weryfikacje', 'blokada', 'uzytkownicy', 'finanse', 'ogloszenia', 'kody'];
      views.forEach(v => document.getElementById(`view-${v}`).classList.add('admin-view-hidden'));
      document.getElementById(`view-${tabName}`).classList.remove('admin-view-hidden');
      
      if(window.innerWidth < 768) {
          toggleSidebar();
      }

      // Wywoływanie odpowiednich funkcji ładujących dane po zmianie karty
      if(tabName === 'dashboard') fetchDashboardStats();
      if(tabName === 'uzytkownicy') fetchUsersFromDB();
      if(tabName === 'weryfikacje') fetchVerifications();
      if(tabName === 'pasek') loadInfoBarData();
      if(tabName === 'finanse') fetchTransactions();
      if(tabName === 'kody') fetchDiscountCodes();
    }

    // --- LOGIKA PASKA INFORMACYJNEGO ---
    let currentBarPage = 'home'; 

    function setInfoBarPage(page) {
        currentBarPage = page;
        
        const tabHome = document.getElementById('bar-tab-home');
        const tabMarket = document.getElementById('bar-tab-market');
        const label = document.getElementById('current-bar-label');
        const editor = document.getElementById('bar-editor-container');

        if (page === 'home') {
            tabHome.className = "px-6 py-2 rounded-lg text-sm font-bold transition bg-[var(--accent)] text-white shadow-lg";
            tabMarket.className = "px-6 py-2 rounded-lg text-sm font-bold transition text-white/50 hover:text-white hover:bg-white/5";
            label.innerText = "STRONA GŁÓWNA";
            editor.style.borderColor = "var(--accent)";
        } else {
            tabMarket.className = "px-6 py-2 rounded-lg text-sm font-bold transition bg-[var(--accent2)] text-white shadow-lg";
            tabHome.className = "px-6 py-2 rounded-lg text-sm font-bold transition text-white/50 hover:text-white hover:bg-white/5";
            label.innerText = "MARKET";
            editor.style.borderColor = "var(--accent2)";
        }

        loadInfoBarData();
    }

    async function loadInfoBarData() {
        try {
            const res = await fetch(`/api/infobar?page=${currentBarPage}`); 
            const data = await res.json();
            
            document.getElementById('bar-active').checked = data.isActive;
            document.getElementById('bar-text').value = data.text || '';
            document.getElementById('bar-link-text').value = data.linkText || '';
            document.getElementById('bar-link-url').value = data.linkUrl || '';
            document.getElementById('bar-bg-color').value = data.bgColor || '#ff0354';
            document.getElementById('bar-text-color').value = data.textColor || '#ffffff';
        } catch (err) { console.error("Błąd ładowania paska", err); }
    }

    async function saveInfoBar() {
        const token = localStorage.getItem('adminToken');
        const payload = {
            page: currentBarPage, 
            isActive: document.getElementById('bar-active').checked,
            text: document.getElementById('bar-text').value,
            linkText: document.getElementById('bar-link-text').value,
            linkUrl: document.getElementById('bar-link-url').value,
            bgColor: document.getElementById('bar-bg-color').value,
            textColor: document.getElementById('bar-text-color').value
        };

        try {
            const res = await fetch('/api/admin/infobar', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            
            if(res.ok) {
                showToast(`Pasek (${currentBarPage}) zaktualizowany!`, false);
            } else {
                showToast("Wystąpił błąd podczas zapisu.", true);
            }
        } catch(err) {
            showToast("Błąd połączenia z serwerem.", true);
        }
    }

    // --- ZAKŁADKA: FINANSE I TRANSAKCJE ---
    let allTransactions = [];

    async function fetchTransactions() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch('/api/admin/transactions', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Błąd pobierania");
        allTransactions = await res.json();
        renderTransactionsTable(allTransactions);
      } catch (err) {
        console.error(err);
        showToast("Błąd pobierania historii transakcji", true);
      }
    }

    function renderTransactionsTable(transactions) {
      const tbody = document.getElementById('transactions-table-body');
      
      if(transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-white/30">Brak historii transakcji w bazie.</td></tr>';
        return;
      }

      tbody.innerHTML = transactions.map(tx => {
        // Obsługa daty (sprawdza format pola z MongoDB)
        const dateObj = new Date(tx.createdAt || tx.date);
        const dateStr = dateObj.toLocaleDateString('pl-PL');
        const timeStr = dateObj.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

        // Obsługa użytkownika (jeśli został usunięty z bazy, tx.userId może być nullem)
        const userName = tx.userId ? (tx.userId.username || tx.userId.email) : 'Usunięty użytkownik';
        const userAvatar = tx.userId ? tx.userId.avatar : 'https://api.dicebear.com/7.x/avataaars/svg?seed=Deleted';

        // Odznaki typu operacji
        let typeBadge = '';
        switch(tx.type) {
          case 'spent': 
            typeBadge = '<span class="px-2 py-1 bg-amber-500/20 text-amber-500 rounded text-[10px] font-bold uppercase">Sklep</span>'; break;
          case 'admin_add': 
          case 'admin_sub': 
            typeBadge = '<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-[10px] font-bold uppercase">Admin</span>'; break;
          case 'topup': 
            typeBadge = '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-[10px] font-bold uppercase">Doładowanie</span>'; break;
          case 'subscription': 
            typeBadge = '<span class="px-2 py-1 bg-pink-500/20 text-pink-400 rounded text-[10px] font-bold uppercase">Subskrypcja</span>'; break;
          default: 
            typeBadge = `<span class="px-2 py-1 bg-white/10 text-white/60 rounded text-[10px] font-bold uppercase">${tx.type || 'Inne'}</span>`;
        }

        // Kwoty i kolory
        const isPositive = Number(tx.amount) > 0;
        const isNegativeOperation = tx.type === 'spent' || tx.type === 'admin_sub' || Number(tx.amount) < 0;
        
        const amountColor = isNegativeOperation ? 'text-red-400' : 'text-green-400';
        const amountPrefix = isNegativeOperation && !String(tx.amount).includes('-') ? '-' : (isPositive && !isNegativeOperation ? '+' : '');

        return `
          <tr class="hover:bg-white/[0.02] transition">
            <td class="px-6 py-4">
               <div class="text-sm font-medium text-white/80">${dateStr}</div>
               <div class="text-xs text-white/30">${timeStr}</div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <img src="${userAvatar}" class="h-8 w-8 rounded-full object-cover bg-white/5" />
                <div class="font-bold text-sm text-white">${userName}</div>
              </div>
            </td>
            <td class="px-6 py-4">${typeBadge}</td>
            <td class="px-6 py-4 text-xs text-white/70 max-w-xs truncate" title="${tx.description}">${tx.description || '-'}</td>
            <td class="px-6 py-4 text-right font-black tracking-wide ${amountColor}">
              ${amountPrefix}${Math.abs(Number(tx.amount)).toFixed(2)} ${tx.currency || 'vPLN'}
            </td>
          </tr>
        `;
      }).join('');
      lucide.createIcons();
    }

    function filterTransactions(query) {
      const lowerQ = query.toLowerCase();
      const filtered = allTransactions.filter(tx => {
        const userName = tx.userId ? (tx.userId.username || tx.userId.email).toLowerCase() : '';
        const desc = (tx.description || '').toLowerCase();
        const type = (tx.type || '').toLowerCase();
        return userName.includes(lowerQ) || desc.includes(lowerQ) || type.includes(lowerQ);
      });
      renderTransactionsTable(filtered);
    }

    // --- ZAKŁADKA: KODY RABATOWE ---
    async function fetchDiscountCodes() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch('/api/admin/discount-codes', { headers: { 'Authorization': `Bearer ${token}` } });
        const codes = await res.json();
        renderDiscountCodesTable(codes);
      } catch (err) {
        showToast("Błąd pobierania kodów", true);
      }
    }

    function renderDiscountCodesTable(codes) {
      const tbody = document.getElementById('codes-table-body');
      if(codes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-white/30">Brak aktywnych kodów rabatowych.</td></tr>';
        return;
      }

      tbody.innerHTML = codes.map(c => {
        const isExpired = c.expiresAt && new Date(c.expiresAt) < new Date();
        const expiryText = c.expiresAt ? new Date(c.expiresAt).toLocaleString('pl-PL', {dateStyle: 'short', timeStyle: 'short'}) : '<span class="text-xl">∞</span>';
        const limitText = c.maxUses ? `${c.currentUses} / ${c.maxUses}` : `${c.currentUses} / ∞`;
        
        return `
          <tr class="hover:bg-white/[0.02] transition ${isExpired ? 'opacity-50 grayscale' : ''}">
            <td class="px-6 py-4 font-black tracking-widest text-[var(--accent)]">${c.code}</td>
            <td class="px-6 py-4 font-bold text-white/80">-${c.discountPercent}%</td>
            <td class="px-6 py-4 text-sm text-white/60">${limitText}</td>
            <td class="px-6 py-4 text-xs ${isExpired ? 'text-red-400' : 'text-white/60'}">${isExpired ? 'Wygasł' : expiryText}</td>
            <td class="px-6 py-4 font-black text-green-400">${Number(c.totalSaved).toFixed(2)} vPLN</td>
            <td class="px-6 py-4 text-right">
              <button onclick="deleteDiscountCode('${c._id}')" class="p-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition">
                <i data-lucide="trash-2" class="h-4 w-4"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      lucide.createIcons();
    }

    async function createDiscountCode() {
      const code = document.getElementById('code-name').value;
      const discountPercent = document.getElementById('code-percent').value;
      const maxUses = document.getElementById('code-uses').value;
      const durationStr = document.getElementById('code-duration').value;
      const token = localStorage.getItem('adminToken');

      if (!code || !discountPercent) return showToast("Kod i zniżka są wymagane", true);

      try {
        const res = await fetch('/api/admin/discount-codes', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, discountPercent, maxUses, durationStr })
        });
        const data = await res.json();

        if (res.ok) {
          showToast("Kod rabatowy został utworzony!");
          document.getElementById('code-name').value = '';
          document.getElementById('code-percent').value = '';
          document.getElementById('code-uses').value = '';
          document.getElementById('code-duration').value = '';
          fetchDiscountCodes();
        } else {
          showToast(data.error || "Błąd podczas tworzenia", true);
        }
      } catch (err) {
        showToast("Błąd sieci", true);
      }
    }

    async function deleteDiscountCode(id) {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(`/api/admin/discount-codes/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          showToast("Kod usunięty!");
          fetchDiscountCodes();
        } else {
            const data = await res.json();
            showToast(data.error || "Błąd", true);
        }
      } catch (err) {
        showToast("Błąd przy usuwaniu", true);
      }
    }

    window.onload = () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        document.getElementById('admin-login-overlay').style.display = 'none';
        setAdminProfile(token);
        fetchUsersFromDB();
        fetchDashboardStats(); // Ładujemy statystyki od razu po zalogowaniu
      }
    };

    function setAdminProfile(token) {
      if (!token) return;
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const payload = JSON.parse(decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
        const discordId = payload.discordId;
        const avatarEl = document.getElementById('admin-avatar');
        const usernameEl = document.getElementById('admin-username');
        if (discordId === '913479364883136532') { avatarEl.src = 'https://i.imgur.com/CX9Evwm.png'; usernameEl.innerText = 'zxq0'; }
        else if (discordId === '810238396953264129') { avatarEl.src = 'https://i.imgur.com/N9OEjiX.png'; usernameEl.innerText = 'adambejmert'; }
      } catch (err) {}
    }

    async function requestAdminOTP() {
      const password = document.getElementById('admin-password').value;
      const errorText = document.getElementById('admin-login-error');
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        currentAdminDiscordId = data.discordId;
        document.getElementById('login-step-1').classList.add('hidden');
        document.getElementById('login-step-2').classList.remove('hidden');
      } catch (err) { errorText.innerText = err.message; }
    }

    async function verifyAdminOTP() {
      const otpCode = document.getElementById('admin-otp').value;
      const errorText = document.getElementById('admin-login-error');
      try {
        const res = await fetch('/api/admin/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ discordId: currentAdminDiscordId, otpCode })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        localStorage.setItem('adminToken', data.token);
        location.reload();
      } catch (err) { errorText.innerText = err.message; }
    }

    async function logoutAdmin() {
      localStorage.removeItem('adminToken');
      location.reload();
    }
  </script>
</body>
</html>
