<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin Panel – Velorie Market</title>
  <meta name="theme-color" content="#0a1030" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --accent: #ff0354;
      --accent2: #7c3aed;
      --bg1: #00010f;
      --bg2: #0a1030;
      --stroke: rgba(255, 255, 255, .12);
    }

    html { scroll-behavior: smooth; }
    body {
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(255,3,84,.16), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      color: rgba(255,255,255,0.9);
      overflow-x: hidden;
    }

    /* Background animations */
    .grid-bg { position: fixed; inset: 0; pointer-events: none; opacity: .22; z-index: -2; background-image: linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px); background-size: 52px 52px; mask-image: radial-gradient(ellipse at center, rgba(0,0,0,.95) 0%, rgba(0,0,0,.20) 55%, transparent 75%); animation: gridFloat 12s ease-in-out infinite; }
    @keyframes gridFloat { 0%,100% { transform: translate3d(0,0,0) scale(1); } 50% { transform: translate3d(0,-10px,0) scale(1.02); } }
    .aurora { position: fixed; inset: -20%; pointer-events: none; filter: blur(46px) saturate(125%); opacity: .90; z-index: -3; }
    .blob { position: absolute; width: clamp(320px, 40vw, 560px); height: clamp(320px, 40vw, 560px); border-radius: 999px; background: radial-gradient(circle at 30% 30%, rgba(255,3,84,.35), transparent 60%), radial-gradient(circle at 70% 70%, rgba(124,58,237,.35), transparent 60%); animation: blob 14s ease-in-out infinite; mix-blend-mode: screen; }
    .blob.b1 { left: 8%; top: 8%; }
    .blob.b2 { width: clamp(360px, 48vw, 680px); height: clamp(360px, 48vw, 680px); left: 62%; top: 18%; background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.38), transparent 60%), radial-gradient(circle at 70% 70%, rgba(255,3,84,.28), transparent 60%); animation-duration: 18s; animation-delay: -3s; }
    @keyframes blob { 0%,100% { transform: translate(0,0) scale(1); } 30% { transform: translate(40px, 18px) scale(1.08); } 60% { transform: translate(-28px, 34px) scale(0.98); } }
    .noise { position: fixed; inset: 0; pointer-events: none; opacity: .09; z-index: -1; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E"); mix-blend-mode: overlay; }

    /* UI Elements */
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05)); border: 1px solid var(--stroke); box-shadow: 0 18px 60px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.10); backdrop-filter: blur(18px); }
    .glass-soft { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); backdrop-filter: blur(14px); }
    .lift { transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
    .lift:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(0,0,0,.6); }

    .btn-primary { background: linear-gradient(135deg, rgba(255,3,84,1), rgba(124,58,237,1)); box-shadow: 0 12px 26px rgba(255,3,84,.18), 0 10px 32px rgba(124,58,237,.16); transition: all 0.2s; }
    .btn-primary:hover { filter: brightness(1.15); box-shadow: 0 14px 30px rgba(255,3,84,.3); transform: translateY(-1px); }
    .btn-ghost { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); transition: all 0.2s; }
    .btn-ghost:hover { background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.2); }
    .btn-danger { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); color: #f87171; transition: all 0.2s; }
    .btn-danger:hover { background: rgba(239,68,68,.2); box-shadow: 0 0 15px rgba(239,68,68,.2); }

    .v-input { width: 100%; border-radius: 12px; padding: 10px 14px; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.14); color: white; outline: none; transition: all 0.2s; }
    .v-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,3,84,.15); background: rgba(0,0,0,.6); }
    
    .brand-logo { height: 32px; width: auto; max-width: 140px; object-fit: contain; filter: drop-shadow(0 10px 22px rgba(255,3,84,.25)); }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,3,84, 0.6); border-radius: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .glow-card { position: relative; }
    .glow-card::before {
      content: ''; position: absolute; inset: -1px; border-radius: inherit; padding: 1px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    
    .admin-view-hidden { display: none !important; }
    
    /* Mobile Menu Transition */
    .mobile-menu-enter { transform: translateX(0) !important; }
  </style>
</head>
<body class="selection:bg-[#ff0354]/40 selection:text-white flex min-h-screen relative">

  <div class="aurora" aria-hidden="true"><div class="blob b1"></div><div class="blob b2"></div></div>
  <div class="grid-bg" aria-hidden="true"></div>
  <div class="noise" aria-hidden="true"></div>

  <div id="admin-login-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-[var(--bg2)]/95 backdrop-blur-xl transition-opacity duration-300">
    <div class="glass rounded-3xl p-8 max-w-sm w-full mx-4 relative overflow-hidden text-center shadow-2xl">
      <img src="https://i.imgur.com/NDhlWyz.png" alt="Velorie" class="brand-logo mx-auto mb-6 h-10 w-auto" />
      
      <div id="login-step-1">
        <h2 class="text-xl font-bold mb-2">Autoryzacja Admina</h2>
        <p class="text-sm text-white/50 mb-6">Wprowadź hasło główne.</p>
        <input type="password" id="admin-password" class="v-input text-center text-lg mb-4 tracking-widest" placeholder="••••••••" />
        <button onclick="requestAdminOTP()" class="btn-primary w-full py-3 rounded-xl font-bold text-sm">Zaloguj</button>
      </div>

      <div id="login-step-2" class="hidden">
        <i data-lucide="shield-check" class="h-12 w-12 text-[var(--accent)] mx-auto mb-3"></i>
        <h2 class="text-xl font-bold mb-2">Weryfikacja Discord</h2>
        <p class="text-sm text-white/50 mb-6">Wysłaliśmy 6-cyfrowy kod na Twoje konto Discord.</p>
        <input type="text" id="admin-otp" class="v-input text-center text-2xl font-black tracking-[0.5em] mb-4" maxlength="6" placeholder="000000" />
        <button onclick="verifyAdminOTP()" class="btn-primary w-full py-3 rounded-xl font-bold text-sm">Zweryfikuj kod</button>
      </div>
      
      <p id="admin-login-error" class="text-red-400 text-xs font-bold mt-4 h-4"></p>
    </div>
  </div>

  <button id="mobile-toggle" onclick="toggleSidebar()" class="fixed top-4 left-4 z-[60] p-2.5 bg-black/40 backdrop-blur-md border border-white/10 rounded-xl text-white shadow-lg md:hidden hover:bg-white/10 transition">
    <i data-lucide="menu" class="h-6 w-6"></i>
  </button>

  <div id="mobile-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden md:hidden transition-opacity"></div>

  <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 glass-soft border-r border-white/10 flex flex-col transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:h-screen shrink-0 bg-[#00010f]/95 md:bg-transparent">
    <div class="p-5 border-b border-white/10 flex items-center gap-3 mt-12 md:mt-0">
      <img src="https://i.imgur.com/NDhlWyz.png" alt="Velorie" class="brand-logo" />
      <div>
        <div class="text-lg font-bold tracking-tight leading-none">Admin</div>
        <div class="text-[10px] uppercase tracking-widest text-[var(--accent)] font-semibold mt-1">Główny Panel</div>
      </div>
    </div>

    <nav class="flex-1 overflow-y-auto p-4 flex flex-col gap-1.5">
      <div class="text-[10px] uppercase font-bold text-white/40 tracking-wider mb-2 mt-2 px-2">Główne statystyki</div>
      <button onclick="switchAdminTab('dashboard')" id="nav-dashboard" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium bg-[var(--accent)]/10 text-[var(--accent)] glow-card">
        <i data-lucide="layout-dashboard" class="h-4 w-4"></i> Statystyki
      </button>

      <div class="text-[10px] uppercase font-bold text-white/40 tracking-wider mb-2 mt-6 px-2">Zarządzanie</div>
      <button onclick="switchAdminTab('pasek')" id="nav-pasek" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="megaphone" class="h-4 w-4"></i> Pasek informacyjny
      </button>
      <button onclick="switchAdminTab('blokada')" id="nav-blokada" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="shield-alert" class="h-4 w-4"></i> Blokada płatności
      </button>

      <div class="text-[10px] uppercase font-bold text-white/40 tracking-wider mb-2 mt-6 px-2">Baza danych</div>
      <button onclick="switchAdminTab('uzytkownicy')" id="nav-uzytkownicy" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="users" class="h-4 w-4"></i> Użytkownicy
      </button>
      <button onclick="switchAdminTab('finanse')" id="nav-finanse" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="banknote" class="h-4 w-4"></i> Finanse
      </button>
      <button onclick="switchAdminTab('ogloszenia')" id="nav-ogloszenia" class="w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5">
        <i data-lucide="layers" class="h-4 w-4"></i> Ogłoszenia
      </button>
    </nav>

    <div class="p-4 border-t border-white/10 flex items-center justify-between">
      <div class="flex items-center gap-3 px-2">
        <div class="h-10 w-10 rounded-full bg-gradient-to-tr from-[var(--accent)] to-[var(--accent2)] p-0.5">
          <img id="admin-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-full w-full rounded-full bg-[#0a1030] object-cover" />
        </div>
        <div>
          <div id="admin-username" class="text-sm font-bold text-white">SuperAdmin</div>
          <div class="text-[11px] text-white/50">Zarządca systemu</div>
        </div>
      </div>
      <button onclick="logoutAdmin()" class="p-2 text-white/50 hover:text-red-400 transition">
        <i data-lucide="log-out" class="h-5 w-5"></i>
      </button>
    </div>
  </aside>

  <main class="flex-1 p-4 md:p-8 relative z-10 w-full overflow-x-hidden pt-20 md:pt-8">
    <div id="view-dashboard" class="space-y-8">
      <div>
        <h1 class="text-3xl sm:text-4xl font-black tracking-tight">Przegląd Systemu</h1>
        <p class="text-white/50 text-sm mt-1">Bieżące statystyki Velorie.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
        <div class="glass rounded-3xl p-6 lift">
            <div class="text-3xl font-black text-white mb-1">4,281</div>
            <div class="text-sm font-medium text-white/50 uppercase tracking-wider">Użytkownicy</div>
        </div>
        </div>
    </div>

    <div id="view-pasek" class="admin-view-hidden space-y-6 max-w-4xl">
      <h2 class="text-3xl font-black tracking-tight">Pasek Informacyjny</h2>
      <div class="glass rounded-3xl p-8 border-l-4 border-blue-500">
        <input type="text" class="v-input mb-4" placeholder="Treść komunikatu..." />
        <button class="btn-primary px-6 py-2.5 rounded-xl font-bold">Publikuj</button>
      </div>
    </div>

    <div id="view-blokada" class="admin-view-hidden space-y-6 max-w-4xl">
      <h2 class="text-3xl font-black tracking-tight text-red-400">Bezpieczeństwo</h2>
      <div class="glass rounded-3xl p-8 text-center border border-red-500/30">
        <button class="btn-danger px-8 py-4 rounded-xl font-bold">ZABLOKUJ PŁATNOŚCI</button>
      </div>
    </div>

    <div id="view-uzytkownicy" class="admin-view-hidden space-y-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 class="text-3xl font-black tracking-tight">Baza Użytkowników</h2>
          <p class="text-white/50 text-sm mt-1">Wszystkie konta (Formularz + Discord).</p>
        </div>
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/40"></i>
          <input type="text" oninput="filterUsers(this.value)" placeholder="Szukaj (nazwa, email)..." class="v-input pl-10 w-full md:w-64 text-sm" />
        </div>
      </div>

      <div class="glass rounded-3xl overflow-hidden border border-white/5">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse whitespace-nowrap">
            <thead>
              <tr class="bg-white/5 text-[10px] uppercase tracking-widest font-bold text-white/40">
                <th class="px-6 py-4">Użytkownik</th>
                <th class="px-6 py-4">Kontakt / Email</th>
                <th class="px-6 py-4">Rejestracja</th>
                <th class="px-6 py-4 text-center">Saldo</th>
                <th class="px-6 py-4 text-right">Opcje</th>
              </tr>
            </thead>
            <tbody id="users-table-body" class="divide-y divide-white/5">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-finanse" class="admin-view-hidden">
        <h2 class="text-3xl font-black tracking-tight mb-6">Finanse</h2>
    </div>

    <div id="view-ogloszenia" class="admin-view-hidden">
        <h2 class="text-3xl font-black tracking-tight mb-6">Ogłoszenia</h2>
    </div>

  </main>

  <div id="user-modal" class="fixed inset-0 z-[110] hidden items-end md:items-center justify-center p-0 md:p-4 bg-black/80 backdrop-blur-md">
    <div class="glass w-full rounded-t-3xl md:rounded-3xl overflow-hidden relative shadow-2xl h-[85vh] md:h-auto md:max-h-[90vh] max-w-4xl flex flex-col md:flex-row">
      <button onclick="closeUserModal()" class="absolute top-4 right-4 z-50 p-2 bg-black/50 rounded-full text-white/40 hover:text-white transition"><i data-lucide="x"></i></button>
      
      <div class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-white/10 p-6 flex flex-col gap-6 bg-black/20 overflow-y-auto shrink-0">
         <div class="flex flex-col items-center text-center">
            <img id="modal-user-avatar" src="" class="h-20 w-20 md:h-28 md:w-28 rounded-full border-4 border-[var(--bg2)] shadow-xl object-cover mb-4" />
            <h3 id="modal-user-name" class="text-xl md:text-2xl font-black leading-tight break-all">---</h3>
            <p id="modal-user-email" class="text-white/40 text-xs mt-1 break-all">---</p>
            <div id="modal-discord-label" class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-[#5865F2]/20 text-[#5865F2] text-[10px] font-bold rounded uppercase hidden">
               <i data-lucide="gamepad-2" class="h-3 w-3"></i> Discord
            </div>
            <div id="modal-form-label" class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-white/10 text-white/60 text-[10px] font-bold rounded uppercase hidden">
                <i data-lucide="mail" class="h-3 w-3"></i> Formularz
            </div>
            <div class="text-[10px] text-white/30 mt-3" id="modal-user-date">Dołączył: ---</div>
         </div>

         <div class="glass-soft p-5 rounded-2xl">
            <label class="text-[10px] uppercase font-bold text-white/40 block mb-2">Saldo Portfela</label>
            <div class="text-3xl font-black text-[#e2b714] mb-4 text-center"><span id="modal-user-balance">0</span> vPLN</div>
            <div class="flex flex-col gap-2">
               <input type="number" id="vpln-amount" class="v-input text-center text-sm" placeholder="Kwota" />
               <div class="flex gap-2">
                 <button onclick="changeBalance('add')" class="flex-1 bg-green-500/10 hover:bg-green-500/20 text-green-400 py-2 rounded-lg text-xs font-bold border border-green-500/20 transition">DODAJ</button>
                 <button onclick="changeBalance('sub')" class="flex-1 bg-red-500/10 hover:bg-red-500/20 text-red-400 py-2 rounded-lg text-xs font-bold border border-red-500/20 transition">ODEJMIJ</button>
               </div>
            </div>
         </div>

         <div class="mt-auto">
            <button onclick="openDeleteConfirm()" class="w-full btn-danger py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="h-4 w-4"></i> Usuń konto trwale
            </button>
         </div>
      </div>

      <div class="w-full md:w-2/3 p-6 flex flex-col gap-6 overflow-y-auto bg-[var(--bg2)]/50">
        
        <div>
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="layers" class="h-5 w-5 text-[var(--accent)]"></i>
                <h4 class="text-sm font-bold uppercase tracking-widest text-white/80">Ogłoszenia / Profile</h4>
            </div>
            <div id="modal-user-ads" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                <div class="text-white/30 text-xs italic">Brak aktywnych ogłoszeń.</div>
            </div>
        </div>

        <div class="w-full h-px bg-white/10"></div>

        <div class="flex-1">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="history" class="h-5 w-5 text-blue-400"></i>
                <h4 class="text-sm font-bold uppercase tracking-widest text-white/80">Ostatnie Transakcje</h4>
            </div>
            <div class="glass-soft rounded-xl overflow-hidden border border-white/5">
                <table class="w-full text-left text-xs">
                    <thead class="bg-white/5 text-white/40 font-semibold">
                        <tr>
                            <th class="p-3">Data</th>
                            <th class="p-3">Typ</th>
                            <th class="p-3 text-right">Kwota</th>
                        </tr>
                    </thead>
                    <tbody id="modal-user-transactions" class="divide-y divide-white/5">
                        <tr><td colspan="3" class="p-4 text-center text-white/30 italic">Brak historii transakcji.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>
  </div>

  <div id="delete-confirm-modal" class="fixed inset-0 z-[120] hidden items-center justify-center bg-black/95 backdrop-blur-sm p-4">
    <div class="glass max-w-sm w-full p-8 rounded-3xl text-center">
      <i data-lucide="alert-triangle" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
      <h4 class="text-2xl font-black mb-2">Jesteś pewny?</h4>
      <p class="text-white/50 text-sm mb-8">Usunięcie konta z MongoDB jest nieodwracalne. Znikną również wszystkie ogłoszenia i saldo.</p>
      <div class="flex gap-4">
        <button onclick="closeDeleteConfirm()" class="flex-1 btn-ghost py-3 rounded-xl">Anuluj</button>
        <button onclick="deleteUser()" class="flex-1 btn-danger py-3 rounded-xl">Usuń</button>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();

    let allUsers = [];
    let selectedUserId = null;

    // --- MOBILE MENU LOGIC ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const backdrop = document.getElementById('mobile-backdrop');
      
      // Sprawdzamy czy sidebar ma klasę translate-x-0 (otwarty na mobile)
      if (sidebar.classList.contains('mobile-menu-enter')) {
        // Zamknij
        sidebar.classList.remove('mobile-menu-enter');
        backdrop.classList.add('hidden');
      } else {
        // Otwórz
        sidebar.classList.add('mobile-menu-enter');
        backdrop.classList.remove('hidden');
      }
    }

    // 1. POBIERANIE Z MONGODB (API)
    async function fetchUsersFromDB() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch('/api/admin/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Błąd pobierania danych");
        allUsers = await res.json();
        renderUsersTable(allUsers);
      } catch (err) {
        console.error("MongoDB Fetch Error:", err);
      }
    }

    // 2. RENDEROWANIE TABELI - WSZYSCY UŻYTKOWNICY
    function renderUsersTable(users) {
      const tbody = document.getElementById('users-table-body');
      
      if(users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-white/30">Brak użytkowników w bazie.</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        // Logika wyświetlania daty i godziny
        const dateObj = new Date(user.createdAt);
        const dateStr = dateObj.toLocaleDateString('pl-PL');
        const timeStr = dateObj.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

        return `
        <tr class="hover:bg-white/[0.02] transition group cursor-pointer" onclick="openUserModal('${user._id}')">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <img src="${user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user.username || user.email)}" class="h-10 w-10 rounded-xl object-cover bg-white/5" />
              <div>
                <div class="font-bold text-sm text-white">${user.username || user.name || 'Brak nazwy'}</div>
                ${user.discordId 
                    ? '<div class="inline-flex items-center gap-1 text-[9px] font-black text-[#5865F2] uppercase bg-[#5865F2]/10 px-1.5 py-0.5 rounded"><i data-lucide="gamepad-2" class="h-2 w-2"></i> Discord</div>' 
                    : '<div class="inline-flex items-center gap-1 text-[9px] font-bold text-white/40 uppercase bg-white/5 px-1.5 py-0.5 rounded"><i data-lucide="mail" class="h-2 w-2"></i> Formularz</div>'}
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-white/70">${user.email}</td>
          <td class="px-6 py-4">
             <div class="text-sm font-medium text-white/80">${dateStr}</div>
             <div class="text-xs text-white/30">${timeStr}</div>
          </td>
          <td class="px-6 py-4 text-center font-bold text-[#e2b714] tracking-wide">${user.vpln || 0} vPLN</td>
          <td class="px-6 py-4 text-right">
            <button class="btn-ghost p-2.5 rounded-xl opacity-0 group-hover:opacity-100 transition hover:bg-white/10 text-white">
              <i data-lucide="settings-2" class="h-4 w-4"></i>
            </button>
          </td>
        </tr>
      `}).join('');
      lucide.createIcons();
    }

    // 3. FILTROWANIE
    function filterUsers(query) {
      const filtered = allUsers.filter(u => 
        (u.username && u.username.toLowerCase().includes(query.toLowerCase())) || 
        (u.name && u.name.toLowerCase().includes(query.toLowerCase())) ||
        (u.email && u.email.toLowerCase().includes(query.toLowerCase()))
      );
      renderUsersTable(filtered);
    }

    // 4. ZARZĄDZANIE SALDEM (API)
    async function changeBalance(type) {
      const amount = parseFloat(document.getElementById('vpln-amount').value);
      if (!amount) return;

      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(`/api/admin/users/${selectedUserId}/balance`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ amount: type === 'add' ? amount : -amount })
        });
        
        if (res.ok) {
          await fetchUsersFromDB(); // Odśwież dane w tabeli
          // Odśwież dane w modalu
          const updatedUser = allUsers.find(u => u._id === selectedUserId);
          if(updatedUser) {
             document.getElementById('modal-user-balance').innerText = updatedUser.vpln;
             // Dodaj wpis do historii transakcji lokalnie (symulacja)
             addMockTransaction(type === 'add' ? amount : -amount, "Korekta Admina");
          }
          document.getElementById('vpln-amount').value = '';
        }
      } catch (err) { alert("Błąd zapisu salda"); }
    }

    // 5. USUWANIE (API)
    async function deleteUser() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(`/api/admin/users/${selectedUserId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          closeDeleteConfirm();
          closeUserModal();
          await fetchUsersFromDB();
        }
      } catch (err) { alert("Błąd usuwania użytkownika"); }
    }

    // --- MODALE ---
    function openUserModal(id) {
      selectedUserId = id;
      const user = allUsers.find(u => u._id === id);
      if (!user) return;

      document.getElementById('modal-user-name').innerText = user.username || user.name || 'Użytkownik';
      document.getElementById('modal-user-email').innerText = user.email;
      document.getElementById('modal-user-balance').innerText = user.vpln || 0;
      document.getElementById('modal-user-avatar').src = user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user.username || user.email);
      
      const regDate = new Date(user.createdAt);
      document.getElementById('modal-user-date').innerText = "Dołączył: " + regDate.toLocaleString('pl-PL');

      const discLabel = document.getElementById('modal-discord-label');
      const formLabel = document.getElementById('modal-form-label');
      
      if (user.discordId) {
          discLabel.classList.remove('hidden');
          formLabel.classList.add('hidden');
      } else {
          discLabel.classList.add('hidden');
          formLabel.classList.remove('hidden');
      }

      renderUserAds(user.listings || []); 
      renderUserTransactions(user.transactions || []); 

      document.getElementById('user-modal').classList.remove('hidden');
      document.getElementById('user-modal').classList.add('flex');
    }

    function renderUserAds(ads) {
        const container = document.getElementById('modal-user-ads');
        if (!ads || ads.length === 0) {
            container.innerHTML = '<div class="p-4 rounded-xl bg-white/5 border border-white/5 text-center text-white/30 text-xs">Brak aktywnych ogłoszeń lub profili.</div>';
            return;
        }
        container.innerHTML = ads.map(ad => `
            <div class="p-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between group hover:bg-white/10 transition">
                <div>
                    <div class="font-bold text-sm text-white">${ad.title || 'Ogłoszenie bez tytułu'}</div>
                    <div class="text-[10px] text-white/50">${ad.category || 'Ogólne'}</div>
                </div>
                <div class="text-[#e2b714] font-bold text-xs">${ad.price || 0} vPLN</div>
            </div>
        `).join('');
    }

    function renderUserTransactions(transactions) {
        const container = document.getElementById('modal-user-transactions');
        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-white/30 text-xs">Brak historii transakcji.</td></tr>';
            return;
        }
        container.innerHTML = transactions.map(t => `
            <tr class="hover:bg-white/5">
                <td class="p-3 text-white/60">${new Date(t.date).toLocaleDateString()}</td>
                <td class="p-3 text-white">${t.type}</td>
                <td class="p-3 text-right font-bold ${t.amount > 0 ? 'text-green-400' : 'text-red-400'}">
                    ${t.amount > 0 ? '+' : ''}${t.amount} vPLN
                </td>
            </tr>
        `).join('');
    }

    function addMockTransaction(amount, type) {
        const container = document.getElementById('modal-user-transactions');
        const emptyMsg = container.querySelector('td[colspan="3"]');
        if(emptyMsg) container.innerHTML = '';
        
        const row = document.createElement('tr');
        row.className = "hover:bg-white/5 animate-pulse";
        row.innerHTML = `
            <td class="p-3 text-white/60">Teraz</td>
            <td class="p-3 text-white">${type}</td>
            <td class="p-3 text-right font-bold ${amount > 0 ? 'text-green-400' : 'text-red-400'}">
                ${amount > 0 ? '+' : ''}${amount} vPLN
            </td>
        `;
        container.insertBefore(row, container.firstChild);
    }

    function closeUserModal() { document.getElementById('user-modal').classList.add('hidden'); document.getElementById('user-modal').classList.remove('flex'); }
    function openDeleteConfirm() { document.getElementById('delete-confirm-modal').classList.remove('hidden'); document.getElementById('delete-confirm-modal').classList.add('flex'); }
    function closeDeleteConfirm() { document.getElementById('delete-confirm-modal').classList.add('hidden'); }

    // --- SYSTEMOWE ---
    function switchAdminTab(tabName) {
      document.querySelectorAll('button[id^="nav-"]').forEach(btn => {
        btn.className = "w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium text-white/70 hover:bg-white/5";
      });
      const activeBtn = document.getElementById(`nav-${tabName}`);
      activeBtn.className = "w-full text-left px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium bg-[var(--accent)]/10 text-[var(--accent)] glow-card";

      const views = ['dashboard', 'pasek', 'blokada', 'uzytkownicy', 'finanse', 'ogloszenia'];
      views.forEach(v => document.getElementById(`view-${v}`).classList.add('admin-view-hidden'));
      document.getElementById(`view-${tabName}`).classList.remove('admin-view-hidden');
      
      // Na mobile: zamknij menu po wybraniu zakładki
      if(window.innerWidth < 768) {
          toggleSidebar();
      }

      if(tabName === 'uzytkownicy') fetchUsersFromDB();
    }

    window.onload = () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        document.getElementById('admin-login-overlay').style.display = 'none';
        setAdminProfile(token);
        fetchUsersFromDB();
      }
    };

    function setAdminProfile(token) {
      if (!token) return;
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const payload = JSON.parse(decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
        const discordId = payload.discordId;
        const avatarEl = document.getElementById('admin-avatar');
        const usernameEl = document.getElementById('admin-username');
        if (discordId === '913479364883136532') { avatarEl.src = 'https://i.imgur.com/CX9Evwm.png'; usernameEl.innerText = 'zxq0'; }
        else if (discordId === '810238396953264129') { avatarEl.src = 'https://i.imgur.com/N9OEjiX.png'; usernameEl.innerText = 'adambejmert'; }
      } catch (err) {}
    }

    async function requestAdminOTP() {
      const password = document.getElementById('admin-password').value;
      const errorText = document.getElementById('admin-login-error');
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        currentAdminDiscordId = data.discordId;
        document.getElementById('login-step-1').classList.add('hidden');
        document.getElementById('login-step-2').classList.remove('hidden');
      } catch (err) { errorText.innerText = err.message; }
    }

    async function verifyAdminOTP() {
      const otpCode = document.getElementById('admin-otp').value;
      const errorText = document.getElementById('admin-login-error');
      try {
        const res = await fetch('/api/admin/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ discordId: currentAdminDiscordId, otpCode })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        localStorage.setItem('adminToken', data.token);
        location.reload();
      } catch (err) { errorText.innerText = err.message; }
    }

    async function logoutAdmin() {
      localStorage.removeItem('adminToken');
      location.reload();
    }
  </script>
</body>
</html>
