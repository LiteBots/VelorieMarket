<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Portfel — Velorie Market</title>
  <meta name="description" content="Doładuj portfel VPLN i zarządzaj historią operacji w Velorie Market." />
  <meta name="theme-color" content="#0a1030" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --accent:#ff0354;
      --accent2:#7c3aed;
      --bg0:#00010f;
      --bg1:#0a1030;

      --glass: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
    }

    body{
      background-color: var(--bg0);
      background-image:
        radial-gradient(1200px 700px at 70% -10%, rgba(10,16,48,1) 0%, rgba(6,6,18,.9) 35%, rgba(0,1,15,1) 70%),
        radial-gradient(900px 550px at 12% 110%, rgba(255,3,84,.18) 0%, rgba(255,3,84,0) 62%),
        radial-gradient(850px 550px at 95% 85%, rgba(124,58,237,.16) 0%, rgba(124,58,237,0) 62%),
        radial-gradient(700px 420px at 40% 35%, rgba(0,163,255,.08) 0%, rgba(0,163,255,0) 70%);
      overflow-x:hidden;
    }

    /* scrollbars */
    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-thumb{ background: var(--accent); border-radius:999px; }
    ::-webkit-scrollbar-track{ background: rgba(255,255,255,.08); }

    /* particles */
    @keyframes particle-animation {
      0%, 100% { transform: translateY(0%) translateX(0%) rotate(0deg); }
      50% { transform: translateY(-10%) translateX(5%) rotate(20deg); }
    }
    .particle{
      animation-name: particle-animation;
      animation-timing-function: ease-in-out;
      animation-iteration-count: infinite;
    }

    /* small helpers */
    .glass{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
  </style>
</head>

<body class="min-h-screen text-white selection:bg-[#ff0354]/40 selection:text-white">

  <!-- Particles background (like prototype) -->
  <div id="particles-container" aria-hidden="true" class="pointer-events-none fixed inset-0 overflow-hidden z-0"></div>

  <!-- Header (same vibe as prototype #1, but connected to market) -->
  <header class="sticky top-0 z-50 backdrop-blur-xl bg-black/20 border-b border-white/10">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-4">
      <a href="./market.html#katalog" class="flex items-center gap-3 flex-shrink-0">
        <div class="h-10 w-10 rounded-xl ring-1 ring-white/10 bg-white/5 flex items-center justify-center font-black">V</div>
        <div class="leading-tight hidden sm:block">
          <div class="text-lg font-semibold tracking-tight">Velorie Market</div>
          <div class="text-xs text-white/60">Portfel (VPLN)</div>
        </div>
      </a>

      <div class="flex items-center gap-2 flex-shrink-0">
        <div class="hidden sm:flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium">
          <i data-lucide="wallet" class="h-4 w-4 text-[var(--accent)]"></i>
          <span id="header-vpln-balance">0.00 VPLN</span>
        </div>

        <a href="./market.html#katalog" class="inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium hover:bg-white/10 transition">
          <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
          <span class="hidden sm:inline">Katalog</span>
        </a>

        <a href="./market.html#katalog" class="inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium hover:bg-white/10 transition">
          <i data-lucide="home" class="h-4 w-4"></i>
          <span class="hidden sm:inline">Strona główna</span>
        </a>

        <a id="logout-btn" href="#" class="inline-flex items-center gap-2 rounded-lg bg-[var(--accent)]/80 text-white px-4 py-2 text-sm font-medium hover:bg-[var(--accent)] transition">
          <i data-lucide="log-out" class="h-4 w-4"></i>
          <span class="hidden sm:inline">Wyloguj</span>
        </a>
      </div>
    </div>
  </header>

  <main class="relative z-10 mx-auto max-w-7xl p-4 md:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">

      <!-- Sidebar (connected to market/account) -->
      <aside class="lg:col-span-1">
        <div class="p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl sticky top-24">
          <div class="flex items-center gap-3 mb-4">
            <div class="h-12 w-12 rounded-xl ring-1 ring-white/10 bg-white/5 overflow-hidden flex items-center justify-center">
              <img id="sidebar-avatar" alt="avatar" class="h-full w-full object-cover hidden" />
              <span id="sidebar-avatar-fallback" class="font-black">V</span>
            </div>
            <div class="min-w-0">
              <div class="font-black tracking-tight truncate" id="sidebar-username">Użytkownik</div>
              <div class="text-xs text-white/60 truncate">
                <span id="sidebar-userid">ID: —</span>
              </div>
            </div>
          </div>

          <nav class="flex flex-col gap-2">
            <a href="./market.html#katalog"
               class="flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
              <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
              <span>Katalog</span>
            </a>

            <button id="btn-open-account" type="button"
              class="flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
              <i data-lucide="user" class="h-6 w-6"></i>
              <span>Konto</span>
            </button>

            <a href="./wallet.html"
               class="flex items-center gap-4 px-5 py-4 rounded-lg bg-white/10 font-semibold text-white transition text-base">
              <i data-lucide="wallet" class="h-6 w-6 text-[var(--accent)]"></i>
              <span>Portfel</span>
            </a>

            <a href="./market.html#katalog"
               class="flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
              <i data-lucide="bookmark" class="h-6 w-6"></i>
              <span>Zapisane</span>
            </a>

            <a href="./market.html#katalog"
               class="flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
              <i data-lucide="book-text" class="h-6 w-6"></i>
              <span>Dokumentacja</span>
            </a>
          </nav>

          <div class="mt-4 rounded-xl border border-white/10 bg-white/5 p-3 text-xs text-white/60">
            Demo front-only: historia i saldo mogą być symulowane (localStorage).
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-4 space-y-8">

        <div>
          <h1 class="text-4xl font-bold">Portfel</h1>
          <p class="text-lg text-white/60 mt-2">
            Doładuj VPLN i przeglądaj historię operacji. (Demo: brak prawdziwych płatności)
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

          <!-- Top up -->
          <div class="p-8 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl space-y-6">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-2xl font-bold">Doładowanie portfela</h2>
              <span class="text-xs font-black text-white/70 bg-white/5 border border-white/10 px-3 py-2 rounded-full">
                Kurs demo: 1 PLN = 1 VPLN
              </span>
            </div>
            <p class="text-white/70">
              Wpisz kwotę i wybierz metodę płatności, aby doładować portfel środkami VPLN.
            </p>

            <div>
              <label for="amount" class="block text-base font-medium text-white/80 mb-2">Kwota doładowania (PLN)</label>
              <input type="number" id="amount" min="1" step="1" placeholder="np. 50"
                class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
              <div class="mt-2 text-xs text-white/55">
                W demo operacja dopisze wpis do historii i zwiększy saldo.
              </div>
            </div>

            <div>
              <label class="block text-base font-medium text-white/80 mb-2">Wybierz metodę płatności</label>
              <div class="grid grid-cols-3 gap-3">
                <button id="pm-transfer" data-method="Przelew"
                  class="text-center p-4 border-2 border-[var(--accent)] bg-[var(--accent)]/10 rounded-lg font-semibold transition">
                  Przelew
                </button>
                <button id="pm-blik" data-method="BLIK"
                  class="text-center p-4 border-2 border-white/10 hover:border-white/30 rounded-lg font-semibold transition">
                  BLIK
                </button>
                <button id="pm-paypal" data-method="PayPal"
                  class="text-center p-4 border-2 border-white/10 hover:border-white/30 rounded-lg font-semibold transition">
                  PayPal
                </button>
              </div>
              <div class="mt-2 text-xs text-white/55">
                Wybrano: <span id="chosen-method" class="text-white/80 font-semibold">Przelew</span>
              </div>
            </div>

            <button id="btn-topup"
              class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-[var(--accent)] px-5 py-3 font-semibold hover:brightness-110 transition shadow-[0_8px_30px_rgba(255,3,84,0.35)]">
              <i data-lucide="credit-card" class="h-5 w-5"></i>
              <span>Doładuj Portfel</span>
            </button>

            <div class="rounded-xl border border-white/10 bg-white/5 p-4 text-sm text-white/70">
              <div class="flex items-start gap-2">
                <i data-lucide="info" class="h-4 w-4 text-[var(--accent)] mt-0.5"></i>
                <div>
                  <div class="font-semibold text-white/85">Integracja z Velorie Market</div>
                  <div class="text-white/60">
                    To jest osobny widok (<b>wallet.html</b>) linkowany z panelu konta w <b>market.html</b>.
                    Logowanie (JWT) i saldo mogą być współdzielone.
                  </div>
                </div>
              </div>
            </div>

          </div>

          <!-- History -->
          <div class="p-8 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
            <div class="flex items-center justify-between gap-3 mb-4">
              <h2 class="text-2xl font-bold">Historia Operacji</h2>
              <button id="btn-clear-history"
                class="inline-flex items-center gap-2 rounded-lg bg-white/5 px-3 py-2 text-xs font-bold border border-white/10 hover:bg-white/10 transition">
                <i data-lucide="trash-2" class="h-4 w-4"></i>
                Wyczyść
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead class="border-b border-white/10 text-sm text-white/60">
                  <tr>
                    <th class="p-3">ID</th>
                    <th class="p-3">Data</th>
                    <th class="p-3">Kwota</th>
                    <th class="p-3">Status</th>
                  </tr>
                </thead>
                <tbody id="history-body"></tbody>
              </table>
            </div>

            <div id="history-empty" class="mt-4 hidden rounded-xl border border-white/10 bg-white/5 p-4 text-sm text-white/70">
              Brak operacji — zrób doładowanie, żeby zobaczyć wpis.
            </div>
          </div>

        </div>

      </section>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      /* -----------------------------------------------------------
       * Shared integration with market.html
       * - JWT key: authToken (optional, like your prototypes)
       * - Market localStorage keys (UX upgrade):
       *   vm_me_v2, vm_subs_v2, vm_settings_v2, etc.
       * - Wallet localStorage:
       *   vm_wallet_history_v1, vm_wallet_balance_v1
       * ----------------------------------------------------------- */

      const LS = {
        walletHistory: "vm_wallet_history_v1",
        walletBalance: "vm_wallet_balance_v1",
        me: "vm_me_v2",
        subs: "vm_subs_v2"
      };

      const $ = (sel, root=document) => root.querySelector(sel);

      function safeParse(v, fb){
        try { return JSON.parse(v); } catch { return fb; }
      }
      function safeStringify(v, fb="[]"){
        try { return JSON.stringify(v); } catch { return fb; }
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function formatDate(d){
        return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
      }
      function randomId(){
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let out = "#";
        for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
        return out;
      }

      // --- JWT decode (same as prototypes) ---
      function decodeJwt(token){
        try { return JSON.parse(atob(token.split(".")[1])); }
        catch { return null; }
      }

      // --- Balance source priority:
      // 1) authToken.vplnBalance
      // 2) vm_wallet_balance_v1
      // 3) 0
      function getBalance(){
        const authToken = localStorage.getItem("authToken");
        if(authToken){
          const data = decodeJwt(authToken);
          if(data && typeof data.vplnBalance !== "undefined"){
            const n = Number(data.vplnBalance);
            return Number.isFinite(n) ? n : 0;
          }
        }
        const stored = Number(localStorage.getItem(LS.walletBalance) || 0);
        return Number.isFinite(stored) ? stored : 0;
      }

      function setBalance(v){
        const n = Number(v);
        const val = Number.isFinite(n) ? n : 0;
        // We don't overwrite JWT (front can't sign). Store local override for demo:
        localStorage.setItem(LS.walletBalance, String(val));
        updateHeaderBalance();
      }

      function updateHeaderBalance(){
        const bal = getBalance();
        const el = $("#header-vpln-balance");
        if(el) el.textContent = `${bal.toFixed(2)} VPLN`;
      }

      // --- User info for sidebar (from JWT OR vm_me_v2) ---
      function hydrateUserSidebar(){
        const usernameEl = $("#sidebar-username");
        const userIdEl = $("#sidebar-userid");
        const avatarImg = $("#sidebar-avatar");
        const avatarFallback = $("#sidebar-avatar-fallback");

        let username = "Użytkownik";
        let userId = "—";
        let avatar = "";

        const authToken = localStorage.getItem("authToken");
        if(authToken){
          const data = decodeJwt(authToken);
          if(data){
            if(data.username) username = data.username;
            if(data.userId) userId = data.userId;
            // no avatar in JWT usually
          }
        }

        const me = safeParse(localStorage.getItem(LS.me), null);
        if(me){
          if(me.name) username = me.name;
          if(me.id) userId = me.id;
          if(me.avatar) avatar = me.avatar;
        }

        if(usernameEl) usernameEl.textContent = username;
        if(userIdEl) userIdEl.textContent = `ID: ${userId}`;

        if(avatar && avatarImg && avatarFallback){
          avatarImg.src = avatar;
          avatarImg.classList.remove("hidden");
          avatarFallback.classList.add("hidden");
        }
      }

      // --- History ---
      function getHistory(){
        const arr = safeParse(localStorage.getItem(LS.walletHistory), null);
        if(Array.isArray(arr)) return arr;
        return [];
      }
      function setHistory(arr){
        localStorage.setItem(LS.walletHistory, safeStringify(arr, "[]"));
      }

      function statusPill(status){
        if(status === "Zakończona"){
          return `<span class="text-xs font-bold bg-green-500/10 text-green-400 px-2 py-1 rounded-full">Zakończona</span>`;
        }
        if(status === "Oczekująca"){
          return `<span class="text-xs font-bold bg-yellow-500/10 text-yellow-400 px-2 py-1 rounded-full">Oczekująca</span>`;
        }
        return `<span class="text-xs font-bold bg-red-500/10 text-red-400 px-2 py-1 rounded-full">${status}</span>`;
      }

      function renderHistory(){
        const tbody = $("#history-body");
        const empty = $("#history-empty");
        if(!tbody) return;

        const hist = getHistory();

        if(!hist.length){
          tbody.innerHTML = "";
          empty?.classList.remove("hidden");
          return;
        }
        empty?.classList.add("hidden");

        tbody.innerHTML = hist.map(row => `
          <tr class="border-b border-white/10 last:border-b-0">
            <td class="p-3 font-mono text-xs">${row.id}</td>
            <td class="p-3 text-sm">${row.date}</td>
            <td class="p-3 font-semibold text-white">${Number(row.amount||0).toFixed(2)} VPLN</td>
            <td class="p-3">${statusPill(row.status || "Zakończona")}</td>
          </tr>
        `).join("");
      }

      // --- Payment method selection ---
      let currentMethod = "Przelew";
      function setMethod(m){
        currentMethod = m;
        $("#chosen-method").textContent = m;

        const ids = ["pm-transfer","pm-blik","pm-paypal"];
        ids.forEach(id=>{
          const b = $("#"+id);
          if(!b) return;
          const isOn = (b.getAttribute("data-method") === m);
          b.className = isOn
            ? "text-center p-4 border-2 border-[var(--accent)] bg-[var(--accent)]/10 rounded-lg font-semibold transition"
            : "text-center p-4 border-2 border-white/10 hover:border-white/30 rounded-lg font-semibold transition";
        });
      }

      // --- Top up (demo) ---
      function doTopup(){
        const input = $("#amount");
        const amount = Number(input?.value || 0);
        if(!Number.isFinite(amount) || amount <= 0){
          input?.focus();
          return;
        }

        // Demo behavior:
        // - Add history item as "Oczekująca" then immediately mark "Zakończona"
        // - Increase balance in vm_wallet_balance_v1
        const hist = getHistory();

        const id = randomId();
        const date = formatDate(new Date());
        const row = { id, date, amount, status: "Oczekująca", method: currentMethod };

        hist.unshift(row);
        setHistory(hist);
        renderHistory();

        // Simulate completion
        setTimeout(()=>{
          const h = getHistory();
          const idx = h.findIndex(x=>x.id===id);
          if(idx >= 0){
            h[idx].status = "Zakończona";
            setHistory(h);
            renderHistory();
          }
          const bal = getBalance();
          setBalance(bal + amount); // demo 1:1
        }, 450);

        if(input) input.value = "";
      }

      // --- Open account panel in market.html (connected UX) ---
      function openAccountInMarket(){
        // simplest: return to market and user taps "Konto"
        // (market has drawer control in JS, but no cross-page API)
        window.location.href = "./market.html#katalog";
      }

      // --- Particles (same idea as prototype #1) ---
      function createParticles(){
        const container = document.getElementById("particles-container");
        if(!container) return;
        const particleCount = 28;

        for(let i=0;i<particleCount;i++){
          const particle = document.createElement("span");
          const size = 24 + (i % 5) * 12;

          particle.className = "absolute rounded-full opacity-20 blur-2xl particle";
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.background = (i % 3) ? "var(--accent)" : "#4f46e5";
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;
          particle.style.animationDuration = `${10 + (i % 5)}s`;
          particle.style.animationDelay = `${i * 0.2}s`;
          container.appendChild(particle);
        }
      }

      // --- Logout (same as prototype #1; returns to index.html) ---
      function bindLogout(){
        const logoutButton = $("#logout-btn");
        if(!logoutButton) return;
        logoutButton.addEventListener("click", (e)=>{
          e.preventDefault();
          localStorage.removeItem("authToken");
          window.location.href = "./index.html";
        });
      }

      // --- Bind UI ---
      function bindUI(){
        $("#pm-transfer")?.addEventListener("click", ()=>setMethod("Przelew"));
        $("#pm-blik")?.addEventListener("click", ()=>setMethod("BLIK"));
        $("#pm-paypal")?.addEventListener("click", ()=>setMethod("PayPal"));

        $("#btn-topup")?.addEventListener("click", doTopup);

        $("#btn-clear-history")?.addEventListener("click", ()=>{
          setHistory([]);
          renderHistory();
        });

        $("#btn-open-account")?.addEventListener("click", openAccountInMarket);

        // submit on Enter in amount
        $("#amount")?.addEventListener("keydown", (e)=>{
          if(e.key === "Enter") doTopup();
        });
      }

      // --- Boot ---
      function boot(){
        createParticles();
        bindLogout();
        bindUI();

        hydrateUserSidebar();
        updateHeaderBalance();

        // Seed history if empty (optional: match prototype feel)
        const hist = getHistory();
        if(!hist.length){
          setHistory([
            { id:"#F8A2D4", date:"20.08.2025", amount:50, status:"Zakończona", method:"Przelew" },
            { id:"#E3B1A9", date:"15.07.2025", amount:20, status:"Zakończona", method:"BLIK" },
            { id:"#C9A8F1", date:"02.06.2025", amount:100, status:"Oczekująca", method:"PayPal" },
            { id:"#B5F3E7", date:"28.05.2025", amount:10, status:"Anulowana", method:"Przelew" }
          ]);
        }
        renderHistory();

        setMethod("Przelew");
        try{ lucide.createIcons(); }catch{}
      }

      boot();
    });
  </script>
</body>
</html>
